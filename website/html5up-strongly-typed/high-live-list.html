<!DOCTYPE HTML>
<!--
	Strongly Typed by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Live HIGH Classes</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body class="no-sidebar is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header">
					<div class="container">

						<!-- Logo -->
							<h1 id="logo"><a href="index.html">Annie Cassie Fit</a></h1>
							<p><strong><span id ="status">Live HIGH Classes</span></strong></p>

						<!-- Nav -->
							<nav id="nav">
								<ul>
									<li><a class="icon solid fa-home" href="home.html"><span>Home</span></a></li>
									<li><a class="icon solid fa-sitemap" href="user-info.html"><span>Your Account</span></a></li>
									<li><a class="icon solid fa-sitemap" href="buy-package.html"><span>Buy A Package</span></a></li>
									<li>
										<a href="#" class="icon fa-chart-bar"><span>High Fitness</span></a>
										<ul>
											<li><a href="high-live-list.html">Book a Live Class</a></li>
											<li><a href="high-fitness.html">Online Streaming</a></li>
										</ul>
									</li>
									<li><a class="icon solid fa-retweet" href="boot-camp.html"><span>Boot Camp</span></a></li>
									<li><a class="icon solid fa-sitemap" href="javascript:signOut()"><span>Sign Out</span></a></li>
								</ul>
							</nav>

					</div>
				</section>

			<!-- Main -->
				<section id="main">
					<div class="container">
						<div class="row">
			
								<section>
											<table id="classlist">
											   <tr>
											      <th>Date</th>
											      <th>Time</th>
											      <th>Location</th>
											      <th>Open Spots</th>
											      <th></th>
											   </tr>
									
											</table>
								
								</section>
								
					
						</div>
					</div>
				</section>
				<div id="copyright" class="container">
						<ul class="links">
							<li>&copy; Annie Cassie Fit. All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
						</ul>
				</div>

			

		</div>

<script>
window.onload = getClassData()

function parseCookie()
{
	if(document.cookie.length > 0)
	{
		jwt = document.cookie.split('; ')
  		.find(row => row.startsWith('auth'))
  		.split('=')[1];
  		return jwt;
	}
	else
	{
		return null
	}
}


function getClassData()
{
	if (document.cookie.length == 0)
	{
		window.location.replace("sign-in.html")
	}
	
	var postRequest = new XMLHttpRequest()

	postRequest.open('POST', 'https://pnbd593pod.execute-api.us-east-2.amazonaws.com/default/any', true)
	postRequest.setRequestHeader('Content-type', 'application/json;charset=UTF-8');
	postRequest.setRequestHeader('X-Api-Key', parseCookie())
	postRequest.onload = function () 
	{
	  // Begin accessing JSON data here
	  var responseData = JSON.parse(this.response)

	  if (postRequest.status >= 200 && postRequest.status < 400) 
	  {
	  		html = '';
	  		json = JSON.parse(postRequest.responseText);
	  		var table = document.getElementById("classlist");
	  		for (var i = 0, l = json.length; i < l; i++) 
	  		{		
    			var obj = json[i];
    			classdate = obj.class_date
    			time = obj.class_time
    			capacity = obj.capacity
    			remaining_spots = capacity
    			display_name = obj.display_name
    			reserved = obj.reserved
    			spots_taken = obj.spots_taken
    			waitspot = obj.waitSpot

    			remaining_spots = capacity - spots_taken
    			if(remaining_spots < 0)
    			{
    				remaining_spots = 0
    			}

    			row = table.insertRow(i +1)
    			row.insertCell(0).innerHTML = classdate;
    			row.insertCell(1).innerHTML = time;
    			row.insertCell(2).innerHTML = display_name;
    			row.insertCell(3).innerHTML = remaining_spots;

    			if(reserved == 'reserved')
    			{
    				row.insertCell(4).innerHTML = "<button type='button' disabled='true' id=" + classdate +" onclick='reserveClass(this)'>You're In!</button>";
    				row.insertCell(5).innerHTML = "<button type='button' id=" + classdate +" onclick='cancelClass(this)'>Cancel Reservation</button>";
    			}
    			else if(reserved == 'waitlisted')
    			{
    				row.insertCell(4).innerHTML = "<button type='button' disabled='true' id=" + classdate +" onclick='reserveClass(this)'>Waitlist # " + waitspot + "</button>";
    				row.insertCell(5).innerHTML = "<button type='button' id=" + classdate +" onclick='cancelClass(this)'>Cancel Waitlist</button>";
    			}
    			else
    			{
    				if(remaining_spots == 0)
    				{
    					row.insertCell(4).innerHTML = "<button type='button' id=" + classdate +" onclick='reserveClass(this)'>Join Waitlist</button>";
    				}
    				else
    				{
    					row.insertCell(4).innerHTML = "<button type='button' id=" + classdate +" onclick='reserveClass(this)'>Reserve</button>";
    				}
    				
    			}
    			
    		}
		}

	  }
	  postRequest.send()
	  document.getElementById("status").textContent="Live HIGH Classes"

	}


function cancelClass(reserve_button)
{	
	document.getElementById("status").textContent="Processing Request... Please Wait"
	classdate = reserve_button.id
	data = {
			"class_date": classdate
		}
	var postRequest = new XMLHttpRequest()

		postRequest.open('POST', 'https://13pr8923nf.execute-api.us-east-2.amazonaws.com/default/any', true)
		postRequest.setRequestHeader('Content-type', 'application/json;charset=UTF-8');
		postRequest.setRequestHeader('X-Api-Key', parseCookie())
		postRequest.onload = function () 
		{
		  // Begin accessing JSON data here
		  var responseData = JSON.parse(this.response)

		  if (postRequest.status >= 200 && postRequest.status < 400) 
		  {	
				window.location.reload()
		  }

	   }
	 

	postRequest.send(JSON.stringify(data))
}
	

function reserveClass(reserve_button)
{ 
	document.getElementById("status").textContent="Processing Request... Please Wait"
	classdate = reserve_button.id
	if(isLoggedIn() == false)
	{
		window.location.replace("sign-in.html")
	}
	else
	{
		checkWaiverStatus();

		data = {
			"class_date": classdate
		}

		var postRequest = new XMLHttpRequest()

		postRequest.open('POST', 'https://48hb1ogb47.execute-api.us-east-2.amazonaws.com/default/any', true)
		postRequest.setRequestHeader('Content-type', 'application/json;charset=UTF-8');
		postRequest.setRequestHeader('X-Api-Key', parseCookie())
		postRequest.onload = function () 
		{
		  // Begin accessing JSON data here
		  var responseData = JSON.parse(this.response)

		  if (postRequest.status >= 200 && postRequest.status < 400) 
		  {	
		  		spotNumber = postRequest.responseText;
				window.location.reload()
		  }

	   }
	  
	}

	postRequest.send(JSON.stringify(data))

}
	

function checkWaiverStatus()
{
	var postRequest = new XMLHttpRequest()

	postRequest.open('POST', 'https://zkhudp5vdk.execute-api.us-east-2.amazonaws.com/default/any', true)
	postRequest.setRequestHeader('Content-type', 'application/json;charset=UTF-8');
	postRequest.setRequestHeader('X-Api-Key', parseCookie())
	//postRequest.withCredentials = true;
	
	postRequest.onload = function () 
	{
	  // Begin accessing JSON data here
	  var responseData = JSON.parse(this.response)

	  if (postRequest.status >= 200 && postRequest.status < 400) 
	  {
	  		json = JSON.parse(postRequest.responseText);
			if(json.waiverSignedDate == null)
			{
				window.alert("Please complete the waiver prior to reserving a class")
				window.location.replace("waiver.html")
			}

	  }
	  
	}

	postRequest.send()
}



function isLoggedIn()
{
	token = parseCookie();
	if(token != null)
	{
		return true
	}
	return false

}

function signOut()
{
	document.cookie = 'auth=' + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
	window.location.replace("index.html");
}
</script>
<!-- Scripts -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/jquery.dropotron.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>

	</body>
</html>